---
title: "Take Home Exercise 2"
subtitle: fish
format: 
  html: 
    code-fold: true
    code-summary: "Show the code"
author: "Fangxian"
execute: 
  eval: true
  warning: false
date: "4 June 2023"
date-modified: "`r Sys.Date()`"
---

# Task

Using the data provide by the VAST challenge, we are looking into the [Mini-Challenge 2](https://vast-challenge.github.io/2023/MC2.html) (MC2) to identify compaines possibly engaged in illegal, unreported, and unregulated (IUU) fishing.

# Data Preparation

## Load Packages

The code chunk below uses `pacman::p_load()` to check if packages are installed. If they are, they will be launched into R. The packages installed are

-   `tidyverse`: A collection of core packages designed for data science, used extensively for data preparation and wrangling.

-   `ggplot2`: Used for plotting different types of graphs.

-   `ggthemes`: Provide additional themes for `ggplot2` .

```{r}
pacman::p_load(jsonlite, tidygraph, ggraph, visNetwork, tidyverse, lubridate, ggplot2, ggthemes, igraph)
```

## Data Importing and wraggling

Import the main MC2 data and some buddle data.

```{r}
MC2 <- jsonlite::fromJSON("data/mc2_challenge_graph.json")
catfish <- jsonlite::fromJSON("data/bundles/carp.json")
tuna <- jsonlite::fromJSON("data/bundles/tuna.json")

glimpse(MC2)
```

Run the below code chunk to preparing the node data. Upon looking into the node data, there are many missing data, to reduce the noise, we remove the missing data from here for further analysis.

```{r}
MC2_nodes <- as_tibble(MC2$nodes) %>%
  select(id,shpcountry,rcvcountry)

glimpse(MC2_nodes)

any(is.na(MC2_nodes))

MC2_nodes_cleaned <- na.omit(MC2_nodes)

any(is.na(MC2_nodes_cleaned))
```

Run the below code chunk to prepare trhe edge data. *Month_Yr* and *Year* were extracted for the temporal analysis in the later part.

```{r}
MC2_edges <- as_tibble(MC2$links) %>%
  mutate(
    Date = as.Date(arrivaldate),
    Month_Yr = format(Date, "%Y-%m"),
    Year = year(Date)) %>%
  select(source, target, Date, Month_Yr, Year, hscode) %>% 
  distinct()
```

Hscode is the Harmonized System with standardized numerical method of classifying traded products. Since we are interested in the fish related products, hscode that is related to fish and its products are shown in the table below.

[![](data/fishhscode.PNG){fig-align="center"}](https://www.fao.org/3/cb3813en/cb3813en.pdf)

Code chunk is run to filter all the hscode with fish related trades and identify the top 3 most traded fish products, namely,

1.  306170: Other shirmps and prawns
2.  304620: Catfish
3.  160414: Tunas, Skipjack And Bonito (sarda Spp), Prepared Or Preserved, Whole Or In Pieces, But Not Minced

```{r}
distinct_hscode <- unique(MC2_edges$hscode)
filtered_hscode <- distinct_hscode[grepl("^30[1-8]|^160[4-5]|^2301|^1212|^1302|^1504|^151610|^151790",distinct_hscode)]

filtered_MC2_edges <- MC2_edges[MC2_edges$hscode %in% filtered_hscode, ]

top_3_hscode <- filtered_MC2_edges %>%
  count(hscode) %>%
  arrange(desc(n)) %>%
  head(3) %>%
  pull(hscode)

top_3_hscode
```

```{r}
MC2_edges_aggregated_306170 <- filtered_MC2_edges %>%
  filter(hscode == "306170")%>%
  group_by(source, target, hscode, Month_Yr, Year) %>%
    summarise(weights = n()) %>%
  filter(source!=target) %>%
  filter(weights > 10) %>%
  ungroup()

glimpse(MC2_edges_aggregated_306170)
```

Want to understand which period most activities.

```{r}
ggplot(data = MC2_edges_aggregated_306170, aes(x = Month_Yr, y = weights)) +
  geom_bar(stat = "identity")+
  ggtitle("Temporal Evolution of Weights")  +
  theme(axis.title.y= element_text(angle=90), axis.ticks.x= element_blank(),
        axis.line= element_line(color= 'grey'),
        axis.text.x = element_text(angle = 90, hjust = 1))
```

```{r}
id1 <- MC2_edges_aggregated_306170 %>%
  select(source) %>%
  rename(id = source)
id2 <- MC2_edges_aggregated_306170 %>%
  select(target) %>%
  rename(id = target)
MC2_nodes_extracted_306170 <- rbind(id1, id2) %>%
  distinct()
```

```{r}
mc2_graph_306170 <- tbl_graph(nodes = MC2_nodes_extracted_306170,
                       edges = MC2_edges_aggregated_306170,
                       directed = TRUE)

```

```{r}
set.seed (1234)
ggraph(mc2_graph_306170,
       layout = "fr") +
  geom_edge_link(aes()) +
  geom_node_point(aes()) +
  theme_graph()
```

```{r}
mc2_graph_306170 <- mc2_graph_306170%>%
  as_tbl_graph()
```

```{r}
quantile_graph_306170 <- quantile(eigen_centrality(mc2_graph_306170)$vector,
         probs = seq(0, 1, 1/5)
         )
V(mc2_graph_306170)$size = eigen_centrality(mc2_graph_306170)$vector

mc2_graph_306170_agg <- delete_vertices(mc2_graph_306170, V(mc2_graph_306170)[size < quantile_graph_306170[5]])


layout1 <- layout_with_fr(mc2_graph_306170_agg)

quantile_graph_306170_agg <- quantile(V(mc2_graph_306170_agg)$size, #identify top 20% of the new vertices
         probs = seq(0, 1, 1/5)
         )

V(mc2_graph_306170_agg)$color <- ifelse (V(mc2_graph_306170_agg)$size > quantile_graph_306170_agg[5], "darkgoldenrod3", "azure3") #color yellow if vertices is top 20%
E(mc2_graph_306170_agg)$color <- "grey"
V(mc2_graph_306170_agg)$size <- V(mc2_graph_306170_agg)$size/0.065 
#Increase the size of nodes based on their centrality score, only those with high score will be visible

plot(mc2_graph_306170_agg, edge.arrow.size=0.25,edge.arrow.mode = "-", vertex.label = V(mc2_graph_306170_agg)$label, vertex.label.cex = 0.65, vertex.label.font = 2, main = "Which id?" ) 

```

```{r}
vertex_attr(mc2_graph_306170_agg, index = V(mc2_graph_306170_agg)$size > quantile_graph_306170_agg[5])
```

```{r}
mc2_graph_306170_agg <- mc2_graph_306170_agg %>%
  as_tbl_graph()

g <- mc2_graph_306170_agg %>%
  mutate(betweenness_centrality = centrality_betweenness()) %>%
  ggraph(layout = "fr") + 
  geom_edge_link(aes(width=weights), 
                 alpha=0.2) +
  scale_edge_width(range = c(0.1, 5)) +
  geom_node_point(aes(colour = id,
            size=betweenness_centrality))
g + theme_graph()
```

```{r}
g <- mc2_graph_306170 %>%
  mutate(community = as.factor(group_edge_betweenness(weights = weights, directed = TRUE))) %>%
  ggraph(layout = "fr") + 
  geom_edge_link(aes(width=weights), 
                 alpha=0.2) +
  scale_edge_width(range = c(0.1, 5)) +
  geom_node_point(aes(colour = community))  

g + theme_graph()
```

```{r}
edges_df <- mc2_graph_306170  %>%
  activate(edges) %>%
  as_tibble()

nodes_df <- mc2_graph_306170 %>%
  activate(nodes) %>%
  as.tibble() %>%
  rename(label = id) %>%
  mutate(id=row_number()) %>%
  select(id, label)
```

```{r}
visNetwork(nodes_df,
           edges_df) %>%
  visIgraphLayout(layout = "layout_with_fr") %>%
  visEdges(arrows = "to", 
           smooth = list(enabled = TRUE, 
                         type = "curvedCW"))
```
